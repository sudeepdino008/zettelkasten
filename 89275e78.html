<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Coroutines - My Zettelkasten</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Sudeep" name="author" /><meta content="Couroutines is a concurrency design pattern. A couroutine is an instance of suspendable computation. It’s similar to thread, but the execution is not bound to a thread. It may suspend execution in one thread, and resume on another. In this sense they are light-weight threads." name="description" /><link href="https://sudeepdino008.github.io/89275e78.html" rel="canonical" /><meta content="Coroutines" property="og:title" /><meta content="My Zettelkasten" property="og:site_name" /><meta content="article" property="og:type" /><script type="application/ld+json">[{"@context":"https://schema.org","itemListElement":[{"name":"Engineering","item":"https://sudeepdino008.github.io/9cfae20f.html","@type":"ListItem","position":1},{"name":"Android","item":"https://sudeepdino008.github.io/c1d717f7.html","@type":"ListItem","position":2}],"@type":"BreadcrumbList"},{"@context":"https://schema.org","itemListElement":[{"name":"Product Builder","item":"https://sudeepdino008.github.io/c55c4f50.html","@type":"ListItem","position":1},{"name":"Android","item":"https://sudeepdino008.github.io/c1d717f7.html","@type":"ListItem","position":2}],"@type":"BreadcrumbList"}]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(165,103,63,0.1)}body nav.bottomPane{background-color:rgba(165,103,63,2.0e-2)}body div#footnotes{border-top-color:#a5673f}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#a5673f;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(165,103,63,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><!-- Font  -->
<!-- TODO: neuron has changed default font, remove it later  -->
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&#38;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,600&#38;display=swap" rel="stylesheet">

<!-- mermaidjs -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
window.addEventListener("load", mermaid.initialize({startOnLoad:true}))
</script>

<!-- graphviz -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js" integrity="sha512-vnRdmX8ZxbU+IhA2gLhZqXkX1neJISG10xy0iP0WauuClu3AIMknxyDjYHEpEhi8fTZPyOCWgqUCnEafDB/jVQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js" integrity="sha512-1zKK2bG3QY2JaUPpfHZDUMe3dwBwFdCDwXQ01GrKSd+/l0hqPbF+aak66zYPUZtn+o2JYi1mjXAqy5mW04v3iA==" crossorigin="anonymous"></script>
<script>
window.addEventListener("load", function(){
  let viz = new Viz();
  for (let element of document.getElementsByClassName("graphviz")) {
    let parent = element.parentNode
    let pparent = parent.parentNode
    viz.renderSVGElement(element.textContent)
    .then(function(element) {
      element.setAttribute("width", "100%")
      pparent.replaceChild(element, parent)
    });
  }
});
</script>

<!-- chartjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js" integrity="sha512-SuxO9djzjML6b9w9/I07IWnLnQhgyYVSpHZx0JV97kGBfTIsUYlWflyuW4ypnvhBrslz1yJ3R+S14fdCWmSmSA==" crossorigin="anonymous"></script>
<script>
window.addEventListener("load", function(){
  for (let element of document.getElementsByClassName("chartjs")) {
    let parent = element.parentNode
    let pparent = parent.parentNode
    let canvas = document.createElement('canvas');
    let box = document.createElement('div');
    box.appendChild(canvas);
    let ctx = canvas.getContext("2d")
    let myChart = new Chart(ctx, JSON.parse(element.textContent));
    box.setAttribute("style","display:block;width:75%;text-align:'center';margin: 5px auto;");
    pparent.replaceChild(box, parent)
  }
});
</script>

<!-- Custom css  -->
<style>

  
img[src$="centerme"] {
  display:block;
  margin: 0 auto;
}

ui.menu {
  font-size: 0.6em;
}

/* tree icon disappear some times*/
body .tree {
  overflow: hidden;
}

/* width */
.ui.text.container {
    min-width: 1000px;
}

@media screen and (min-width: 700px) {
    .ui.attached.segment {
      padding: 50px;
    }
}

* {
  font-size: 17px;
}

body div.zettel-view .zettel-content h1 {
  font-family: "Crimson Text", serif !important;
  font-weight: 600 !important;
  padding: 0.3rem !important;
  border-bottom: none;
  text-align: left;
  background-color: inherit !important;
}

body div.zettel-view .zettel-content h2 {
  font-family: "Crimson Text", serif !important;
  font-weight: 600 !important;
  padding: 0.3rem !important;
  font-size: 1.75rem !important;
  border-bottom: none;
  text-align: left;
  background-color: inherit !important;
}


body div.zettel-view .zettel-content h3 {
  font-family: "Crimson Text", serif !important;
  font-weight: 600 !important;
  padding: 0.3rem !important;
  font-size: 1.5rem !important;
  border-bottom: none;
  text-align: left;
  background-color: inherit !important;
}

body div.zettel-view .zettel-content h4 {
  font-family: "Crimson Text", serif !important;
  font-weight: 600 !important;
  font-size: 1.25rem !important;
  padding: 0.3rem !important;
  border-bottom: none;
  text-align: left;
  background-color: inherit !important;
}

/* title */
#zettel-container > div.zettel-view > article > h1:first-child {
/* body div#neuron-theme-default-black .zettel-content h1 { */
  /* text-align: center !important; */
  font-family: "Crimson Text", serif !important;
  /* font-style: italic; */
  text-align: right;
  font-weight: normal !important;
  font-size: 2rem;
  padding: 1rem;
  /* padding-top: 1rem; */
  /* padding-right: 1rem; */
  /* padding-left: 1rem; */
  background-color: inherit !important;
}

#neuron-theme-default-black > div > h1 {
  font-family: "Crimson Text", serif !important;
  font-weight: normal;
}

/* divider */
.ui.horizontal.divider:before {
  width: 100%;
}

/* logo */
div.ui.one.column.grid.footer-version > div > div > a > img {
  display:none !important;
}

div.ui.one.column.grid.footer-version > div > div > a:before {
  content: "© 2020 shifuda" !important;
  font-size: 0.8rem;
}

/* link */
body div#neuron-theme-default-black span.zettel-link-container span.zettel-link a {
  color: inherit !important;
}

time {
  font-family: "Crimson Text", monospace !important;
}

body code, pre, tt {
  font-family: "Source Code Pro", monospace !important;
}

.ui.text.container {
  font-family: "Crimson Text", serif !important;
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

</style>
<!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><nav class="flipped tree deemphasized" id="zettel-uptree" style="transform-origin: 50%"><ul class="root"><li><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2020-11-25T10:18"><a href="c1d717f7.html">Android</a></span></span></div><ul><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2021-01-20T13:42"><a href="c55c4f50.html">Product Builder</a></span></span></div></li><li><div class="forest-link"><span class="zettel-link-container"><span class="zettel-link" title="2020-09-24T23:17"><a href="9cfae20f.html">Engineering</a></span></span></div></li></ul></li></ul></li></ul></nav><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Coroutines</h1><p>Couroutines is a concurrency design pattern.<br />A couroutine is an instance of suspendable computation. It’s similar to thread, but the execution is not bound to a thread. It may suspend execution in one thread, and resume on another. In this sense they are light-weight threads.</p><ul><li>DO NOT BLOCK THE MAIN THREAD the main thread has to update the screen every 16ms or more, which is about 60fps. More than this and the UI can freeze and even give ANR for longer operations.</li></ul><h2 id="skeleton">Skeleton</h2><ul><li>where to execute? - dispatchers</li><li>things needed for lifecycle management and error propagation/recovery? - job, coroutine scope</li><li>how to create them? - scope builders and coroutine builders</li></ul><h2 id="next-important-stuff">next important stuff</h2><ul><li>error propagation: <a href="https://kotlinlang.org/docs/exception-handling.html">https://kotlinlang.org/docs/exception-handling.html</a></li><li>android support for coroutines - <a href="https://developer.android.com/topic/libraries/architecture/coroutines#lifecyclescope">Use Kotlin coroutines with Architecture components </a> and <a href="https://developer.android.com/courses/pathways/android-coroutines#codelab-https://developer.android.com/codelabs/kotlin-coroutines">codelab</a></li></ul><h2 id="funda">Funda</h2><h3 id="structured-concurrency">Structured Concurrency</h3><ul><li>new coroutines can only be launched in a CoroutineScope, this helps in delimiting the lifetime of a coroutine and makes sure it doesn’t leak.</li><li>An outer scope doesn’t complete unless all the inner ones are done.</li><li>structured concurrency also ensures that all the errors are properly handled and never lost.</li></ul><h2 id="inheritance">Inheritance</h2><p><a href="https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html#children-of-a-coroutine">children of a coroutine</a></p><ul><li>a parent coroutine always waits for completion of all its children. It doesn’t have to explicitly track all the children it launches, and doesn’t have to do <strong>Job.join()</strong> to wait for them at the end.</li></ul><h2 id="coroutines-are-light-weight">Coroutines are light-weight</h2><ul><li>how does it achieve suspending the thread?</li></ul><h2 id="coroutinescope">CoroutineScope</h2><ul><li>all coroutines run inside a CoroutineScope. It controls the lifetime of couroutines present inside it, meaning that if the job associated with the CoroutineScope is cancelled, the associated coroutines are cancelled too.</li><li>It also allows to specify dispatchers (like main, IO) which controls the thread in which the coroutines run.</li><li>viewModelScope: an extension function to ViewModel. The scope is bound to <strong>Dispatchers.Main</strong> and will automatically be cancelled when the <strong>ViewModel</strong> is cleared.<br />use <strong>launch</strong> when you don’t have a result to return, use async when you do (as async returns a job which can be joined on).</li></ul><h3 id="scope-builder">Scope builder</h3><ul><li><strong>runBlocking</strong> is a scope builder which bridges the non-coroutine world and one with couroutines. It blocks the builder thread till it completes and is a non-suspending function.</li><li><strong>coroutineScope</strong> is similar to runBlocking, the difference is that it’a a suspending function and doesn’t block the builder thread.</li><li>a non-suspend (and common) way to create scopes would be then to use <strong>CoroutineScope</strong> constructor - <code>CoroutineScope(Dispatchers.IO)</code></li></ul><h2 id="couroutinecontext">CouroutineContext</h2><ul><li>set of various elements. A couroutine executes in some context.</li><li>the main elements are Dispatchers and Job.</li><li>At implementation level, CoroutineScope contains a single field of type CoroutineContext (with job and dispatcher)</li></ul><h3 id="dispatcher">Dispatcher</h3><ul><li><p>represented by <strong>CoroutineDispatcher</strong>. It’s a type of <strong>CoroutineContext</strong></p></li><li><p>3 main dispatchers: Main, IO (optimised for IO and network), Default (for cpu intensive operations)</p></li><li><p>when should custom dispatchers be created?</p></li></ul><h3 id="job">Job</h3><ul><li>It’s a handle to the launched coroutine. It’s returned by the coroutine builders like launch and async.</li></ul><h2 id="coroutine-builders">Coroutine builders</h2><ul><li>launch, async, withContext etc. are coroutine builders.</li><li>They accept an optional CouroutineContext, otherwise it’s inherited from the couroutine scope it is being launched from.</li><li><strong>withContext</strong> can be used to switch to another dispatcher. It’s useful when you have to return a value from a suspend function or coroutine scope.</li></ul><pre><code class="kotlin language-kotlin">return withContext(Dispatchers.IO) {
  val result = try {
    network.fetchNextTitle().execute()
  } catch (cause: Throwable) {
    throw TitleRefreshError(&quot;Unable to refresh title&quot;, cause)
  }

  if (result.isSuccessful) {
    titleDao.insertTitle(Title(result.body()!!))
    return &quot;success&quot;
  } else {
    throw TitleRefreshError(&quot;unable to refresh title&quot;, null)
  }
}
</code></pre><h2 id="suspend">suspend</h2><pre><code class="kotlin language-kotlin">// Slow request with coroutines
@UiThread
suspend fun makeNetworkRequest() {
    // slowFetch is another suspend function so instead of 
    // blocking the main thread  makeNetworkRequest will `suspend` until the result is 
    // ready
    val result = slowFetch()
    // continue to execute after the result is ready
    show(result)
}

// slowFetch is main-safe using coroutines
suspend fun slowFetch(): SlowResult { ... }</code></pre><ul><li><strong>suspend</strong> keyword doesn’t specify the thread code runs on. Those may run on a background or main thread.</li><li><strong>suspend</strong> functions can only be called from other suspend functions or from inside a coroutine scope.</li><li>the key advantage is that the code becomes sequential, rather than callbacks based (which is harder to read and reason about)</li><li>how is suspend function implemented?? Is it internally translated to a coroutine builder.</li></ul><hr /><h2 id="debugging"><a href="https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html#debugging-coroutines-and-threads">debugging</a></h2><pre><code class="kotlin language-kotlin">println(&quot;My job is ${coroutineContext[Job]}&quot;)

in debug mode, it outputs something like:
My job is &quot;coroutine#1&quot;:BlockingCoroutine{Active}@6d311334
</code></pre><p>name the coroutines for debbuging:</p><pre><code class="kotlin language-kotlin">val v1 = async(CoroutineName(&quot;v1coroutine&quot;)) {
    delay(500)
    log(&quot;Computing v1&quot;)
    252
}</code></pre><hr /><h4 id="resources">resources</h4><ul><li><a href="https://www.youtube.com/watch?v=KMb0Fs8rCRs">testing coroutines on android</a></li><li><a href="https://developer.android.com/courses/pathways/android-coroutines">android coroutine course</a></li><li><a href="https://www.youtube.com/watch?v=YrrUCSi72E8">deep dive into coroutines</a></li></ul><p>next stuff<br /><a href="https://kotlinlang.org/docs/flow.html">https://kotlinlang.org/docs/flow.html</a> <a href="https://kotlinlang.org/docs/channels.html">https://kotlinlang.org/docs/channels.html</a> <a href="https://kotlinlang.org/docs/exception-handling.html">https://kotlinlang.org/docs/exception-handling.html</a> <a href="https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html">https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html</a></p></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-03-14T13:54">2021-03-14</time></div></div></article><nav class="ui attached segment deemphasized backlinksPane" id="neuron-backlinks-pane"><h3 class="ui header"><span title="Backlinks from folgezettel parents">Uplinks</span></h3><ul class="backlinks"><li><span class="zettel-link-container folge"><span class="zettel-link" title="2020-11-25T10:18"><a href="c1d717f7.html">Android</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span><ul class="context-list" style="zoom: 85%;"><li class="item"><div class="pandoc"><span class="zettel-link-container folge"><span class="zettel-link" title="2021-03-14T13:54"><a href="89275e78.html">Coroutines</a><span data-nosnippet="" style="user-select: none; color: gray" title="Folgezettel">#</span></span></span></div></li></ul></li></ul></nav><nav class="ui bottom attached icon compact inverted menu brown" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="right item" href="impulse.html" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.27.0" /></a></div></div></div></body></html>